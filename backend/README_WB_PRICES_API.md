# WB Prices API - Документация

## Описание
API для получения и обновления цен товаров с Wildberries API. Система автоматически разбивает запросы на батчи и обновляет цены в базе данных.

## Эндпоинты

### 1. Обновление цен товаров
**GET** `/api/wb-prices/update`

Получает цены с WB API для всех товаров в базе данных и обновляет их.

#### Параметры запроса:
- `limit` (опционально) - количество элементов на странице (по умолчанию: 100, максимум: 1000)
- `offset` (опционально) - смещение для пагинации (по умолчанию: 0)

#### Пример запроса:
```bash
GET /api/wb-prices/update?limit=500&offset=0
```

#### Ответ:
```json
{
  "success": true,
  "message": "Обновление цен завершено",
  "data": {
    "totalProducts": 1500,
    "totalUpdated": 1200,
    "totalErrors": 50,
    "batchesProcessed": 2,
    "results": [
      {
        "batchIndex": 1,
        "batchSize": 1000,
        "updated": 800,
        "errors": 20
      },
      {
        "batchIndex": 2,
        "batchSize": 500,
        "updated": 400,
        "errors": 30
      }
    ]
  }
}
```

### 2. Статус обновления цен
**GET** `/api/wb-prices/status`

Получает информацию о последнем обновлении цен и статистику покрытия.

#### Ответ:
```json
{
  "success": true,
  "data": {
    "lastUpdate": "2024-01-15T10:30:00.000Z",
    "totalProducts": 1500,
    "productsWithPrices": 1200,
    "coveragePercentage": 80
  }
}
```

### 3. Обновление цен для конкретного WB кабинета
**GET** `/api/wb-prices/cabinet/:cabinetId`

Обновляет цены только для товаров конкретного WB кабинета.

#### Параметры пути:
- `cabinetId` - ID WB кабинета

#### Параметры запроса:
- `limit` (опционально) - количество элементов на странице
- `offset` (опционально) - смещение для пагинации

#### Пример запроса:
```bash
GET /api/wb-prices/cabinet/68638d3e6a6f5a5478ac947e?limit=500
```

#### Ответ:
```json
{
  "success": true,
  "message": "Обновление цен для кабинета завершено",
  "data": {
    "cabinetName": "Electromix",
    "totalProducts": 150,
    "updated": 120,
    "errors": 5
  }
}
```



## Логика работы

### 1. Получение WB кабинетов
- Система получает все WB кабинеты с установленными токенами
- Каждый кабинет имеет свой уникальный токен для доступа к WB API

### 2. Группировка товаров по кабинетам
- Для каждого кабинета находятся связанные склады через `IntegrationLink`
- Товары группируются по складам, связанным с конкретным кабинетом
- Используется связь через поле `sizes.ms_href.storage`

### 3. Разбиение на батчи
- Товары каждого кабинета разбиваются на батчи по 1000 (лимит WB API)
- Каждый батч обрабатывается отдельно

### 4. Запрос к WB API
- Для каждого батча формируется запрос к `https://discounts-prices-api.wildberries.ru/api/v2/list/goods/filter`
- Используется токен соответствующего WB кабинета в заголовке `Authorization`
- Параметр `filterNmID` содержит nmID товаров, разделенные точкой с запятой

### 5. Обновление базы данных
- Для каждого товара из ответа WB API:
  - Находится соответствующий товар в БД по nmID
  - Для каждого размера обновляются цены:
    - `priceWB` ← `price` из WB API
    - `discountedPriceWB` ← `discountedPrice` из WB API
    - `clubDiscountedPriceWB` ← `clubDiscountedPrice` из WB API
  - Обновляется время последнего обновления цен

### 6. Сопоставление размеров
- Размеры сопоставляются по полю `chrtID` в БД и `sizeID` в ответе WB API
- Обновляются только те размеры, для которых найдены соответствующие данные

### 7. Обработка множественных кабинетов
- Каждый WB кабинет обрабатывается отдельно со своим токеном
- Между кабинетами делаются паузы для избежания перегрузки API
- Результаты агрегируются по всем кабинетам

## Безопасность
- Все эндпоинты защищены middleware аутентификации
- Требуется валидный JWT токен в заголовке `Authorization`

## Обработка ошибок
- Система продолжает работу даже при ошибках в отдельных батчах
- Логируются все ошибки с детальной информацией
- Возвращается общая статистика по успешным и неуспешным обновлениям

## Мониторинг
- Подробное логирование всех операций
- Статистика по каждому батчу
- Время последнего обновления для каждого товара
- Процент покрытия товаров ценами

## Примеры использования

### Обновление всех цен (для всех кабинетов):
```bash
curl -X GET "http://localhost:3900/api/wb-prices/update" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Обновление цен для конкретного кабинета:
```bash
curl -X GET "http://localhost:3900/api/wb-prices/cabinet/68638d3e6a6f5a5478ac947e" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Проверка статуса:
```bash
curl -X GET "http://localhost:3900/api/wb-prices/status" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```



## Автоматическое обновление
- При запуске сервера автоматически запускается первое обновление цен
- Далее обновление происходит каждые 5 минут автоматически
- Все обновления логируются в консоль сервера

## Примечания
- Система автоматически делает паузы между батчами для избежания перегрузки API
- Максимальный размер батча ограничен 1000 товарами согласно лимитам WB API
- Автоматическое обновление работает в фоновом режиме без вмешательства пользователя 