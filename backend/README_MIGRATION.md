# Миграция модели Product - Добавление полей цен и остатков

## Описание изменений

В модель `Product` добавлены новые поля для каждого размера товара в массиве `sizes`:

### Новые поля для каждого размера:

#### Цены Wildberries:
- `priceWB` - базовая цена на Wildberries
- `discountedPriceWB` - цена со скидкой на Wildberries  
- `clubDiscountedPriceWB` - цена со скидкой для участников клуба WB

#### Цены МойСклад:
- `priceMS` - цена в МойСклад
- `costPriceMS` - себестоимость в МойСклад

#### Остатки:
- `stockMS` - остаток в МойСклад
- `stockFBS` - остаток FBS (Fulfillment by Seller)
- `stockFBY` - остаток FBY (Fulfillment by Yandex)

#### Время обновления:
- `lastPriceUpdate` - время последнего обновления цен
- `lastStockUpdate` - время последнего обновления остатков

## Структура данных

Каждый элемент в массиве `sizes` теперь имеет следующую структуру:

```javascript
{
  chrtID: Number,
  techSize: String,
  wbSize: String,
  skus: [String],
  ms_href: String,
  
  // Новые поля
  priceWB: { type: Number, default: 0 },
  discountedPriceWB: { type: Number, default: 0 },
  clubDiscountedPriceWB: { type: Number, default: 0 },
  priceMS: { type: Number, default: 0 },
  costPriceMS: { type: Number, default: 0 },
  stockMS: { type: Number, default: 0 },
  stockFBS: { type: Number, default: 0 },
  stockFBY: { type: Number, default: 0 },
  lastPriceUpdate: { type: Date, default: null },
  lastStockUpdate: { type: Date, default: null }
}
```

## Запуск миграции

### 1. Убедитесь, что у вас установлены зависимости:
```bash
cd backend
npm install
```

### 2. Настройка подключения к БД
Создайте файл `.env` или установите переменную `MONGODB_URI`:
```bash
export MONGODB_URI="mongodb://localhost:27017"
```

**Важно**: База данных по умолчанию - `wbms_db`, коллекция - `products`

### 3. Запустите миграцию:

#### Вариант 1: Через Mongoose модель (рекомендуется)
```bash
npm run migrate:products
```

#### Вариант 2: Прямая миграция MongoDB (если первый не работает)
```bash
npm run migrate:products:direct
```

## Что делает миграция

1. Подключается к MongoDB (база данных `wbms_db`)
2. Находит все существующие товары в коллекции `products`
3. Для каждого товара проверяет массив `sizes`
4. Добавляет новые поля с значениями по умолчанию (0 для чисел, null для дат)
5. Обновляет документы в базе данных
6. Выводит статистику по результатам миграции

## Диагностика проблем

Если миграция не находит товары, скрипт покажет:
- Доступные базы данных
- Доступные коллекции
- Текущее подключение
- Примеры найденных документов

## Результат

После успешной миграции все существующие товары будут иметь новую структуру с полями для цен и остатков, готовыми для заполнения данными через API запросы.

## Безопасность

- Миграция не удаляет существующие данные
- Все новые поля имеют значения по умолчанию
- Процесс можно запускать многократно без потери данных
- В случае ошибки с одним товаром, остальные продолжают обрабатываться

## Мониторинг

Миграция выводит подробную информацию о процессе:
- Количество найденных товаров
- Количество обновленных товаров
- Количество ошибок
- Детали по каждому обновленному товару 