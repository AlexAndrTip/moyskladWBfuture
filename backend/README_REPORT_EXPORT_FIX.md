# Исправление проблемы с выгрузкой отчетов в МойСклад

## Проблема

При выгрузке отчетов в МойСклад возникала ошибка **HTTP 412 Precondition Failed** при добавлении позиций в документ `commissionreportin`.

## Причина

МойСклад не принимает позиции с **нулевым количеством** (`quantity: 0`). В отчетах Wildberries часто встречаются строки с нулевым количеством, которые содержат информацию о комиссии, но не о продаже товара.

## Решение

### 1. Фильтрация позиций с нулевым количеством

В функции `fillReportPositionsAndOverhead` добавлена проверка:

```javascript
// Пропускаем позиции с нулевым количеством - МойСклад их не принимает
if (r.quantity === 0 || r.quantity === null || r.quantity === undefined) {
  console.log(`[MS_EXPORT] Пропускаем позицию с нулевым количеством: ${r.barcode}, reward: ${r.ppvz_for_pay}`);
  continue;
}
```

### 2. Валидация данных перед отправкой

Добавлена проверка корректности всех позиций:

```javascript
const validatePosition = (pos, index, type) => {
  if (pos.quantity <= 0) {
    throw new Error(`Позиция ${index} (${type}): некорректное количество ${pos.quantity}`);
  }
  if (pos.price < 0) {
    throw new Error(`Позиция ${index} (${type}): некорректная цена ${pos.price}`);
  }
  // Комиссия может быть любой (положительной, отрицательной, нулевой) - это нормально для WB отчетов
  if (!pos.assortment?.meta?.href) {
    throw new Error(`Позиция ${index} (${type}): отсутствует ссылка на товар`);
  }
};
```

### 3. Правильная логика расчета комиссии

Используется корректный способ расчета комиссии для отчетов Wildberries:

```javascript
// Для всех типов: комиссия = розничная цена - выплата продавцу
// Это дает реальную комиссию WB, а не то, что получит продавец
if (r.doc_type_name === 'Продажа') {
  reward = Math.round(((r.retail_amount || 0) - (r.ppvz_for_pay || 0)) * 100);
} 
else if (r.doc_type_name === 'Возврат') {
  reward = Math.round(((r.retail_amount || 0) - (r.ppvz_for_pay || 0)) * 100);
} 
else {
  reward = Math.round(((r.retail_amount || 0) - (r.ppvz_for_pay || 0)) * 100);
}
```

**Пример расчета:**
- Розничная цена: 16 183,35 руб
- Выплата продавцу: 1 405,72 руб  
- **Комиссия WB**: 16 183,35 - 1 405,72 = **14 777,63 руб** ✅

### 4. Улучшенное логирование

Добавлено детальное логирование для диагностики:

- Количество строк в отчете
- Строки с нулевым количеством
- Примеры позиций для отправки
- Детали ошибок при отправке чанков

### 5. Проверка наличия позиций

Если после фильтрации не осталось позиций для отправки, функция завершается с предупреждением:

```javascript
if (sales.length === 0 && returns.length === 0) {
  console.warn('[MS_EXPORT] Внимание: нет позиций для отправки в МойСклад после фильтрации');
  return;
}
```

## Инструменты диагностики

### Скрипт валидации данных

Создан скрипт `validateReportData.js` для проверки данных отчета перед выгрузкой:

```bash
node validateReportData.js <userId> <reportId> <integrationLinkId>
```

Скрипт анализирует:
- Строки с нулевым количеством
- Строки с отрицательными ценами
- Строки без штрихкода
- Наличие товаров в БД
- MS ссылки товаров
- Имитирует создание позиций для МойСклад

## Логика работы

1. **Создание отчета** - создается пустой документ `commissionreportin` в МойСклад
2. **Фильтрация данных** - из строк отчета исключаются некорректные позиции
3. **Расчет комиссии** - используется новая логика для корректного расчета комиссии WB
4. **Валидация** - проверяется корректность оставшихся позиций
5. **Отправка** - позиции отправляются в МойСклад чанками по 1000
6. **Обновление overhead** - устанавливается сумма накладных расходов

## Важные моменты

- **Не группируем товары** - каждая продажа остается отдельной позицией
- **Сохраняем все данные** - цена, количество, комиссия для каждой позиции
- **Фильтруем только некорректные** - позиции с нулевым количеством
- **Правильная логика комиссии** - комиссия = розничная цена - выплата продавцу (как было раньше)
- **Логируем все действия** - для диагностики проблем

## Мониторинг

После внедрения исправлений следите за логами:

- `[MS_EXPORT] Пропускаем позицию с нулевым количеством` - нормально
- `[MS_EXPORT] Валидация пройдена` - успешная проверка
- `[MS_EXPORT] Позиции отправлены` - успешная выгрузка

## Тестирование

1. Запустите скрипт валидации для проблемного отчета
2. Проверьте логи при выгрузке
3. Убедитесь, что позиции успешно добавляются в МойСклад
4. Проверьте корректность данных в МойСклад
