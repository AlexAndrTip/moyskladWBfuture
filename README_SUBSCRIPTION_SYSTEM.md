# Система подписок WBMS

## Обзор

Добавлена система подписок для контроля доступа пользователей к функциям системы. Система поддерживает три типа подписок: демо, базовая и премиум.

## Типы подписок

### 1. Демо (demo)
- **Статус**: Всегда активно, но с ограничениями
- **Доступ**: Только просмотр данных
- **Ограничения**: 
  - Нельзя создавать товары в МойСклад
  - Нельзя связывать товары
  - Нельзя выполнять массовые операции
  - Нельзя создавать поставки

### 2. Базовая (basic)
- **Статус**: Активно до указанной даты
- **Доступ**: Полный доступ к основным функциям
- **Ограничения**: Некоторые премиум функции недоступны

### 3. Премиум (premium)
- **Статус**: Активно до указанной даты
- **Доступ**: Полный доступ ко всем функциям

## Структура базы данных

### Обновленная модель User
```javascript
subscription: {
  type: {
    type: String,
    enum: ['demo', 'basic', 'premium'],
    default: 'demo'
  },
  expiresAt: {
    type: Date,
    default: null
  },
  isActive: {
    type: Boolean,
    default: true
  }
}
```

## Backend изменения

### 1. Модель User (backend/src/models/User.js)
- Добавлены поля подписки
- Добавлены методы для проверки подписки:
  - `isSubscriptionActive()` - проверка активности подписки
  - `getSubscriptionStatus()` - получение статуса подписки

### 2. Middleware подписки (backend/src/middleware/subscriptionMiddleware.js)
- `requireSubscription(requiredType)` - проверка подписки для маршрутов
- `getSubscriptionInfo()` - получение информации о подписке

### 3. Контроллер подписок (backend/src/controllers/subscriptionController.js)
- `getSubscription()` - получение информации о подписке пользователя
- `updateSubscription()` - обновление подписки (только для админов)
- `getAllSubscriptions()` - список всех подписок (только для админов)

### 4. Маршруты подписок (backend/src/routes/subscriptionRoutes.js)
- `GET /api/subscription` - информация о подписке
- `PUT /api/subscription/:userId` - обновление подписки
- `GET /api/subscription/all` - все подписки

## Frontend изменения

### 1. Отображение статуса подписки
- В заголовке дашборда показывается статус подписки
- Формат: "Подписка: Демо" или "Подписка активна до: ДД.ММ.ГГГГ"

### 2. Composable для подписки (frontend/src/composables/useSubscription.js)
- `isDemo` - проверка демо режима
- `isSubscriptionActive` - проверка активности подписки
- `canUseFeatures` - проверка возможности использования функций
- `getSubscriptionMessage` - сообщение о подписке

### 3. Компонент блокировки (frontend/src/components/DemoBlock.vue)
- Блокирует функции в демо режиме
- Показывает сообщение о необходимости обновления подписки

### 4. Обновленные страницы
- **Товары** - заблокированы кнопки создания и связывания
- **Поставки** - заблокированы кнопки массовых операций

## Использование

### Проверка подписки в компонентах
```javascript
import { useSubscription } from '../composables/useSubscription';

const { isDemo, canUseFeatures } = useSubscription();

// Проверка перед выполнением действия
if (isDemo.value) {
  alert('Функция недоступна в демо версии');
  return;
}
```

### Блокировка функций
```vue
<template>
  <DemoBlock>
    <!-- Содержимое, которое будет заблокировано в демо режиме -->
  </DemoBlock>
</template>
```

### Обновление подписки (для админов)
```javascript
// Обновление подписки пользователя
await axios.put(`/api/subscription/${userId}`, {
  type: 'basic',
  expiresAt: '2024-12-31'
});
```

## Администрирование

### Просмотр всех подписок
```javascript
const response = await axios.get('/api/subscription/all');
console.log(response.data.subscriptions);
```

### Обновление подписки пользователя
```javascript
const response = await axios.put(`/api/subscription/${userId}`, {
  type: 'premium',
  expiresAt: '2024-12-31'
});
```

## Безопасность

- Все маршруты подписок защищены middleware аутентификации
- Обновление подписок доступно только администраторам
- Проверка подписки происходит на уровне backend и frontend

## Тестирование

1. **Демо режим**: Создайте пользователя с подпиской типа 'demo'
2. **Базовая подписка**: Обновите подписку на 'basic' с датой истечения
3. **Премиум подписка**: Обновите подписку на 'premium'

## Логирование

Система логирует:
- Проверки подписки
- Ошибки доступа
- Обновления подписок

## Будущие улучшения

- Автоматическое уведомление об истечении подписки
- Интеграция с платежными системами
- Статистика использования функций
- Градация функций по типам подписок 